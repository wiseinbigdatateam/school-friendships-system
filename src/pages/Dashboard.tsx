import React, { useState, useEffect } from "react";
import { supabase } from "../lib/supabase";
import { NotificationService } from "../services/notificationService";
import BarChart from "../components/BarChart";

interface SurveyProject {
  id: string;
  title: string;
  templateType: string;
  date: string;
  status: "active" | "completed";
  questions: any[];
  targetGrades: any;
  targetClasses: any;
  isSelected: boolean;
  template_id?: string | null;
}

interface SurveyTemplate {
  id: string;
  name: string;
  metadata: {
    category: string;
    answer_options?: any;
  };
}

const Dashboard: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [schoolId, setSchoolId] = useState("");
  const [schoolName, setSchoolName] = useState("");
  const [gradeLevel, setGradeLevel] = useState("");
  const [classNumber, setClassNumber] = useState("");
  const [teacherInfo, setTeacherInfo] = useState({ name: "", role: "" });
  const [currentUser, setCurrentUser] = useState<any>(null);
  const [selectedProject, setSelectedProject] = useState("");
  const [surveyProjects, setSurveyProjects] = useState<Array<SurveyProject>>(
    []
  );
  const [surveyTemplates, setSurveyTemplates] = useState<Array<SurveyTemplate>>(
    []
  );
  const [participationData, setParticipationData] = useState({
    totalStudents: 0,
    participatedStudents: 0,
    nonParticipatedStudents: 0,
    completionRate: 0,
  });
  const [dailyParticipationData, setDailyParticipationData] = useState<
    Array<{
      date: string;
      count: number;
      cumulative: number;
    }>
  >([]);
  const [studentParticipationList, setStudentParticipationList] = useState<
    Array<{
      id: number;
      name: string;
      participated: boolean;
      ownName: string;
      closeFriends: string;
      playFriends: string;
      talkFriends: string;
    }>
  >([]);
  const [students, setStudents] = useState<any[]>([]);
  const [responses, setResponses] = useState<any[]>([]);

  // ÏÉÅÌÉúÎ•º ÌïúÍ∏ÄÎ°ú Î≥ÄÌôòÌïòÎäî Ìï®Ïàò
  const getStatusLabel = (status: string): string => {
    switch (status) {
      case "active":
        return "ÏßÑÌñâÏ§ë";
      case "completed":
        return "ÏôÑÎ£å";
      default:
        return status;
    }
  };

  // ÏÉÅÌÉúÏóê Îî∞Î•∏ Ïä§ÌÉÄÏùº ÌÅ¥ÎûòÏä§ Î∞òÌôò
  const getStatusStyle = (status: string): string => {
    switch (status) {
      case "completed":
        return "bg-green-100 text-green-800";
      case "active":
        return "bg-blue-100 text-blue-800";
      default:
        return "bg-gray-100 text-gray-800";
    }
  };

  // ÏÑ§Î¨∏ ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù Ìï∏Îì§Îü¨
  const handleProjectSelect = async (projectId: string) => {
    // Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏Ïùò ÏÑ†ÌÉù ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
    const updatedProjects = surveyProjects.map((project) => ({
      ...project,
      isSelected: project.id === projectId,
    }));

    setSurveyProjects(updatedProjects);
    setSelectedProject(projectId);

    // ÏÑ†ÌÉùÎêú ÏÑ§Î¨∏Ïùò ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
    if (projectId && students.length > 0) {
      try {
        // Ìï¥Îãπ ÏÑ§Î¨∏Ïùò ÏùëÎãµ Ï°∞Ìöå
        const { data: responsesData, error: responsesError } = await supabase
          .from("survey_responses")
          .select("*")
          .eq("survey_id", projectId)
          .order("submitted_at", { ascending: true });

        if (responsesError) {
          console.error("‚ùå ÏÑ§Î¨∏ ÏùëÎãµ Ï°∞Ìöå Ïã§Ìå®:", responsesError);
        } else {
          setResponses(responsesData || []);

          // Ï∞∏Ïó¨ ÌòÑÌô© Ïû¨Í≥ÑÏÇ∞
          const totalStudents = students.length;
          const participatedStudents = responsesData
            ? responsesData.filter((r) =>
                students.some((s) => s.id === r.student_id)
              ).length
            : 0;
          const nonParticipatedStudents = totalStudents - participatedStudents;
          const completionRate =
            totalStudents > 0
              ? Math.round((participatedStudents / totalStudents) * 100)
              : 0;

          setParticipationData({
            totalStudents,
            participatedStudents,
            nonParticipatedStudents,
            completionRate,
          });

          // ÌïôÏÉù Ï∞∏Ïó¨ Î¶¨Ïä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
          const studentList = students.map((student, index) => {
            const response = responsesData?.find(
              (r) => r.student_id === student.id
            );
            const participated = !!response;

            return {
              id: index + 1,
              name: student.name,
              participated,
              ownName: student.name,
              closeFriends: "", // Ïù¥Ï†ú ÎèôÏ†ÅÏúºÎ°ú Í≥ÑÏÇ∞Îê®
              playFriends: "", // Ïù¥Ï†ú ÎèôÏ†ÅÏúºÎ°ú Í≥ÑÏÇ∞Îê®
              talkFriends: "", // Ïù¥Ï†ú ÎèôÏ†ÅÏúºÎ°ú Í≥ÑÏÇ∞Îê®
            };
          });

          setStudentParticipationList(studentList);

          // ÏùºÎ≥Ñ Ï∞∏Ïó¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
          const dailyData = responsesData
            ? responsesData
                .reduce((acc: any[], response) => {
                  if (!response.submitted_at) return acc;

                  const date = new Date(response.submitted_at)
                    .toLocaleDateString("ko-KR", {
                      month: "2-digit",
                      day: "2-digit",
                    })
                    .replace(/\./g, "-");

                  const existingDate = acc.find((d) => d.date === date);
                  if (existingDate) {
                    existingDate.count += 1;
                  } else {
                    acc.push({
                      date,
                      count: 1,
                      cumulative: 0,
                    });
                  }

                  // ÎàÑÏ†Å ÏùëÎãµÏàò Í≥ÑÏÇ∞
                  acc.forEach((dayData, index) => {
                    if (index === 0) {
                      dayData.cumulative = dayData.count;
                    } else {
                      dayData.cumulative =
                        acc[index - 1].cumulative + dayData.count;
                    }
                  });

                  return acc;
                }, [])
                .sort((a, b) => {
                  // ÎÇ†ÏßúÏàúÏúºÎ°ú Ï†ïÎ†¨
                  const dateA = new Date(a.date.replace(/-/g, "/"));
                  const dateB = new Date(b.date.replace(/-/g, "/"));
                  return dateA.getTime() - dateB.getTime();
                })
            : [];

          console.log("‚úÖ ÏÑ§Î¨∏ Î≥ÄÍ≤Ω - ÏµúÏ¢Ö ÏùºÎ≥Ñ Ï∞∏Ïó¨ Îç∞Ïù¥ÌÑ∞:", dailyData);
          setDailyParticipationData(dailyData);

          console.log(
            "‚úÖ ÏÑ§Î¨∏ Î≥ÄÍ≤ΩÏóê Îî∞Î•∏ ÏùºÎ≥Ñ Ï∞∏Ïó¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏:",
            dailyData
          );
        }
      } catch (error) {
        console.error("‚ùå ÏÑ§Î¨∏ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®:", error);
      }
    }
  };

  // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    const loadRealData = async () => {
      try {
        // 1. Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©Ïûê ÌôïÏù∏ (ÏÑ†ÌÉùÏ†Å)
        const userStr = localStorage.getItem("user");
        let user = null;

        if (userStr) {
          try {
            user = JSON.parse(userStr);
          } catch (e) {
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌååÏã± Ïã§Ìå® Ïãú Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î°ú ÏßÑÌñâ
          }
        } else {
          // Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏùÑ Ïãú Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Î°ú ÏßÑÌñâ
        }

        // 2. Í∏∞Î≥∏ Ï†ïÎ≥¥ ÏÑ§Ï†ï (Ïã§Ï†ú DB Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)
        const schoolId = "ab466857-5c16-4329-a9f6-f2d081c864f0"; // ÏôÄÏù¥Ï¶àÏù∏Ïª¥ÌçºÎãà
        const gradeLevel = "1";
        const classNumber = "1";

        setSchoolId(schoolId);
        setGradeLevel(gradeLevel);
        setClassNumber(classNumber);
        setCurrentUser(
          user || { id: "default", name: "ÍπÄÎã¥ÏûÑ", role: "homeroom_teacher" }
        );
        setTeacherInfo({
          name: "ÍπÄÎã¥ÏûÑ",
          role: "homeroom_teacher",
        });

        // 3. ÌïôÍµê Ïù¥Î¶Ñ ÏÑ§Ï†ï
        setSchoolName("ÏôÄÏù¥Ï¶àÏù∏Ïª¥ÌçºÎãà");

        // 4. ÌïôÏÉù Î™©Î°ù Ï°∞Ìöå
        const { data: studentsData, error: studentsError } = await supabase
          .from("students")
          .select("*")
          .eq("current_school_id", schoolId)
          .eq("grade", gradeLevel)
          .eq("class", classNumber);

        if (studentsError) {
          console.error("‚ùå ÌïôÏÉù Ï°∞Ìöå Ïã§Ìå®:", studentsError);
          setLoading(false);
          return;
        }

        setStudents(studentsData || []);

        if (studentsData && studentsData.length > 0) {
          // 5. ÏÑ§Î¨∏ Î™©Î°ù Ï°∞Ìöå (activeÏôÄ completed ÏÉÅÌÉúÎßå Ìè¨Ìï®)
          console.log("üîç ÏÑ§Î¨∏ Ï°∞Ìöå ÏãúÏûë:", { schoolId });
          const { data: surveys, error: surveysError } = await supabase
            .from("surveys")
            .select("*")
            .eq("school_id", schoolId)
            .in("status", ["active", "completed"]) // draft Ï†úÏô∏
            .order("created_at", { ascending: false });

          if (surveysError) {
            console.error("‚ùå ÏÑ§Î¨∏ Ï°∞Ìöå Ïã§Ìå®:", surveysError);
          } else {
            console.log("‚úÖ ÏõêÎ≥∏ ÏÑ§Î¨∏ Îç∞Ïù¥ÌÑ∞:", surveys);
            console.log("üìä Ï¥ù ÏÑ§Î¨∏ Í∞úÏàò:", surveys?.length || 0);
            // target_gradesÏôÄ target_classesÍ∞Ä ÏùºÏπòÌïòÎäî ÏÑ§Î¨∏Îßå ÌïÑÌÑ∞ÎßÅ
            const filteredSurveys =
              surveys?.filter((survey) => {
                const targetGrades = survey.target_grades;
                const targetClasses = survey.target_classes;

                console.log(`üîç ÏÑ§Î¨∏ "${survey.title}" ÌïÑÌÑ∞ÎßÅ Ï≤¥ÌÅ¨:`, {
                  gradeLevel,
                  classNumber,
                  targetGrades,
                  targetClasses,
                });

                const gradeMatch = Array.isArray(targetGrades)
                  ? targetGrades.includes(gradeLevel)
                  : targetGrades === gradeLevel;

                const classMatch = Array.isArray(targetClasses)
                  ? targetClasses.includes(classNumber)
                  : targetClasses === classNumber;

                const isMatch = gradeMatch && classMatch;
                console.log(`üìã ÏÑ§Î¨∏ "${survey.title}" Îß§Ïπ≠ Í≤∞Í≥º:`, {
                  gradeMatch,
                  classMatch,
                  isMatch,
                });

                return isMatch;
              }) || [];

            console.log("üéØ ÌïÑÌÑ∞ÎßÅ ÌõÑ ÏÑ§Î¨∏ Í∞úÏàò:", filteredSurveys.length);
            console.log(
              "üìù ÌïÑÌÑ∞ÎßÅ Îêú ÏÑ§Î¨∏Îì§:",
              filteredSurveys.map((s) => ({ title: s.title, status: s.status }))
            );

            // ÏÑ§Î¨∏ ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù ÏÑ§Ï†ï (Îçî ÏûêÏÑ∏Ìïú Ï†ïÎ≥¥ Ìè¨Ìï®)
            const projects = await Promise.all(
              filteredSurveys.map(async (survey) => {
                let templateType = "Ïª§Ïä§ÌÖÄ ÏÑ§Î¨∏";

                // ÌÖúÌîåÎ¶ø Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                if (survey.template_id) {
                  try {
                    const { data: templateData, error: templateError } =
                      await supabase
                        .from("survey_templates")
                        .select("name, metadata")
                        .eq("id", survey.template_id)
                        .single();

                    if (!templateError && templateData) {
                      const metadata = templateData.metadata as any;
                      const category = metadata?.category || "";
                      templateType = `ÌÖúÌîåÎ¶øÌòï: ${category}`;
                    }
                  } catch (error) {
                    console.error("ÌÖúÌîåÎ¶ø Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:", error);
                    templateType = "ÌÖúÌîåÎ¶øÌòï: Ïïå Ïàò ÏóÜÏùå";
                  }
                }

                return {
                  id: survey.id,
                  title: survey.title || "Ï†úÎ™© ÏóÜÏùå",
                  templateType,
                  date: survey.created_at
                    ? new Date(survey.created_at).toLocaleDateString("ko-KR")
                    : "ÎÇ†Ïßú ÏóÜÏùå",
                  status: (survey.status as "active" | "completed") || "draft",
                  questions: Array.isArray(survey.questions)
                    ? survey.questions
                    : [],
                  targetGrades: survey.target_grades,
                  targetClasses: survey.target_classes,
                  description: survey.description || "",
                  startDate: survey.start_date || "",
                  endDate: survey.end_date || "",
                  isSelected: false,
                };
              })
            );

            setSurveyProjects(projects);

            // ÏÑ§Î¨∏ ÌÖúÌîåÎ¶ø Ï†ïÎ≥¥ Ï†ÄÏû•
            const templateIds = filteredSurveys
              .filter((survey) => survey.template_id)
              .map((survey) => survey.template_id)
              .filter((id): id is string => id !== null);

            if (templateIds.length > 0) {
              try {
                const { data: templatesData, error: templatesError } =
                  await supabase
                    .from("survey_templates")
                    .select("id, name, metadata")
                    .in("id", templateIds);

                if (!templatesError && templatesData) {
                  const processedTemplates = templatesData.map((template) => ({
                    id: template.id,
                    name: template.name,
                    metadata: template.metadata as any,
                  }));
                  setSurveyTemplates(processedTemplates);
                  console.log("ÏÑ§Î¨∏ ÌÖúÌîåÎ¶ø Ï†ïÎ≥¥:", processedTemplates);
                }
              } catch (error) {
                console.error("ÌÖúÌîåÎ¶ø Ï†ïÎ≥¥ Ï°∞Ìöå Ïã§Ìå®:", error);
              }
            }

            // 6. Ï≤´ Î≤àÏß∏ ÏÑ§Î¨∏ ÏÑ†ÌÉù Î∞è ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
            if (projects.length > 0) {
              const firstProject = projects[0];
              firstProject.isSelected = true;
              setSelectedProject(firstProject.id);

              // Ìï¥Îãπ ÏÑ§Î¨∏Ïùò ÏùëÎãµ Ï°∞Ìöå (Îçî ÏûêÏÑ∏Ìïú Ï†ïÎ≥¥ Ìè¨Ìï®)
              const { data: responsesData, error: responsesError } =
                await supabase
                  .from("survey_responses")
                  .select("*")
                  .eq("survey_id", firstProject.id)
                  .order("submitted_at", { ascending: true });

              if (responsesError) {
                console.error("‚ùå ÏÑ§Î¨∏ ÏùëÎãµ Ï°∞Ìöå Ïã§Ìå®:", responsesError);
              } else {
                setResponses(responsesData || []);

                // Ï∞∏Ïó¨ ÌòÑÌô© Í≥ÑÏÇ∞
                const totalStudents = studentsData.length;
                const participatedStudents = responsesData
                  ? responsesData.filter((r) =>
                      studentsData.some((s) => s.id === r.student_id)
                    ).length
                  : 0;
                const nonParticipatedStudents =
                  totalStudents - participatedStudents;
                const completionRate =
                  totalStudents > 0
                    ? Math.round((participatedStudents / totalStudents) * 100)
                    : 0;

                setParticipationData({
                  totalStudents,
                  participatedStudents,
                  nonParticipatedStudents,
                  completionRate,
                });

                // ÌïôÏÉù Ï∞∏Ïó¨ Î¶¨Ïä§Ìä∏ ÏÑ§Ï†ï (Ïã§Ï†ú ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò, Îçî Ï†ïÌôïÌïú ÌååÏã±)
                const studentList = studentsData.map((student, index) => {
                  const response = responsesData?.find(
                    (r) => r.student_id === student.id
                  );
                  const participated = !!response;

                  // ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÏπúÍµ¨ Ï†ïÎ≥¥ Ï∂îÏ∂ú (Îçî Ï†ïÌôïÌïú ÌååÏã±)
                  let closeFriends = "";
                  let playFriends = "";
                  let talkFriends = "";

                  if (response && response.responses) {
                    try {
                      const responseData = response.responses as any;

                      // q1: Í∞ÄÏû• ÏπúÌïú ÏπúÍµ¨ 3Î™Ö
                      if (responseData.q1 && Array.isArray(responseData.q1)) {
                        const friendNames = responseData.q1
                          .map((friendId: string) => {
                            const friend = studentsData.find(
                              (s) => s.id === friendId
                            );
                            return friend ? friend.name : "Ïïå Ïàò ÏóÜÏùå";
                          })
                          .filter((name: string) => name !== "Ïïå Ïàò ÏóÜÏùå");
                        closeFriends = friendNames.join(", ");
                      }

                      // q2: Ìï®Íªò ÎÜÄÍ≥† Ïã∂ÏùÄ ÏπúÍµ¨ 5Î™Ö
                      if (responseData.q2 && Array.isArray(responseData.q2)) {
                        const friendNames = responseData.q2
                          .map((friendId: string) => {
                            const friend = studentsData.find(
                              (s) => s.id === friendId
                            );
                            return friend ? friend.name : "Ïïå Ïàò ÏóÜÏùå";
                          })
                          .filter((name: string) => name !== "Ïïå Ïàò ÏóÜÏùå");
                        playFriends = friendNames.join(", ");
                      }

                      // q3: Í≥†ÎØº ÏÉÅÎã¥ÌïòÍ≥† Ïã∂ÏùÄ ÏπúÍµ¨
                      if (responseData.q3 && Array.isArray(responseData.q3)) {
                        const friendNames = responseData.q3
                          .map((friendId: string) => {
                            const friend = studentsData.find(
                              (s) => s.id === friendId
                            );
                            return friend ? friend.name : "Ïïå Ïàò ÏóÜÏùå";
                          })
                          .filter((name: string) => name !== "Ïïå Ïàò ÏóÜÏùå");
                        talkFriends = friendNames.join(", ");
                      }

                      // q4: Ï°¥Í≤ΩÌïòÍ±∞ÎÇò ÎãÆÍ≥† Ïã∂ÏùÄ ÏπúÍµ¨ (ÏûàÎäî Í≤ΩÏö∞)
                      if (responseData.q4 && Array.isArray(responseData.q4)) {
                        const friendNames = responseData.q4
                          .map((friendId: string) => {
                            const friend = studentsData.find(
                              (s) => s.id === friendId
                            );
                            return friend ? friend.name : "Ïïå Ïàò ÏóÜÏùå";
                          })
                          .filter((name: string) => name !== "Ïïå Ïàò ÏóÜÏùå");
                        // q4Îäî Î≥ÑÎèÑ Ïª¨ÎüºÏù¥ ÏóÜÏúºÎØÄÎ°ú closeFriendsÏóê Ï∂îÍ∞Ä
                        if (friendNames.length > 0) {
                          closeFriends = closeFriends
                            ? `${closeFriends}, ${friendNames.join(", ")}`
                            : friendNames.join(", ");
                        }
                      }
                    } catch (e) {
                      console.error("ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:", e);
                    }
                  }

                  return {
                    id: index + 1,
                    name: student.name,
                    participated,
                    ownName: student.name,
                    closeFriends:
                      closeFriends || (participated ? "ÏπúÍµ¨ ÏÑ†ÌÉùÎê®" : ""),
                    playFriends:
                      playFriends || (participated ? "ÏπúÍµ¨ ÏÑ†ÌÉùÎê®" : ""),
                    talkFriends:
                      talkFriends || (participated ? "ÏπúÍµ¨ ÏÑ†ÌÉùÎê®" : ""),
                  };
                });

                setStudentParticipationList(studentList);

                // ÏùºÎ≥Ñ Ï∞∏Ïó¨ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï (Ïã§Ï†ú Ï†úÏ∂ú ÏãúÍ∞Ñ Í∏∞Î∞ò)
                const dailyData = responsesData
                  ? responsesData
                      .reduce((acc: any[], response) => {
                        if (!response.submitted_at) return acc;

                        const date = new Date(response.submitted_at)
                          .toLocaleDateString("ko-KR", {
                            month: "2-digit",
                            day: "2-digit",
                          })
                          .replace(/\./g, "-");

                        console.log(
                          `üîç ÏùëÎãµ ÎÇ†Ïßú Ï≤òÎ¶¨: ${response.submitted_at} ‚Üí ${date}`
                        );

                        const existingDate = acc.find((d) => d.date === date);
                        if (existingDate) {
                          existingDate.count += 1;
                          console.log(
                            `‚úÖ Í∏∞Ï°¥ ÎÇ†Ïßú ${date} ÏóÖÎç∞Ïù¥Ìä∏: ${existingDate.count}Î™Ö`
                          );
                        } else {
                          acc.push({
                            date,
                            count: 1,
                            cumulative: 0,
                          });
                          console.log(`üÜï ÏÉà ÎÇ†Ïßú ${date} Ï∂îÍ∞Ä: 1Î™Ö`);
                        }

                        // ÎàÑÏ†Å ÏùëÎãµÏàò Í≥ÑÏÇ∞
                        acc.forEach((dayData, index) => {
                          if (index === 0) {
                            dayData.cumulative = dayData.count;
                          } else {
                            dayData.cumulative =
                              acc[index - 1].cumulative + dayData.count;
                          }
                          console.log(
                            `üìä ${dayData.date}: ÏùëÎãµÏàò ${dayData.count}Î™Ö, ÎàÑÏ†Å ${dayData.cumulative}Î™Ö`
                          );
                        });

                        return acc;
                      }, [])
                      .sort((a, b) => {
                        // ÎÇ†ÏßúÏàúÏúºÎ°ú Ï†ïÎ†¨
                        const dateA = new Date(a.date.replace(/-/g, "/"));
                        const dateB = new Date(b.date.replace(/-/g, "/"));
                        return dateA.getTime() - dateB.getTime();
                      })
                  : [];

                setDailyParticipationData(dailyData);
              }
            } else {
              // ÏÑ§Î¨∏Ïù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞Îßå ÏÑ§Ï†ï
              setParticipationData({
                totalStudents: studentsData.length,
                participatedStudents: 0,
                nonParticipatedStudents: studentsData.length,
                completionRate: 0,
              });

              setStudentParticipationList([]);
              setDailyParticipationData([]);
            }
          }
        }

        setLoading(false);
      } catch (error) {
        console.error("‚ùå Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:", error);
        setLoading(false);
      }
    };

    loadRealData();
  }, []);

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  // dashboardData Ï°∞Í±¥Î¨∏ Ï†úÍ±∞ - ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Î°úÎìúÎê®

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ÌéòÏù¥ÏßÄ Ï†úÎ™© */}
      <div className="bg-white border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          <div className="flex items-center justify-center space-x-6">
            <h1 className="text-3xl font-bold text-gray-900">
              {selectedProject
                ? surveyProjects.find((p) => p.id === selectedProject)?.title ||
                  "ÍµêÏö∞Í¥ÄÍ≥Ñ Ï°∞ÏÇ¨"
                : "ÍµêÏö∞Í¥ÄÍ≥Ñ Ï°∞ÏÇ¨"}
            </h1>

            {/* ÏÑ§Î¨∏ ÏÉÅÌÉú */}
            <div
              className={`px-3 py-1 rounded-full text-sm font-medium ${
                selectedProject &&
                surveyProjects.find((p) => p.id === selectedProject)?.status
                  ? getStatusStyle(
                      surveyProjects.find((p) => p.id === selectedProject)
                        ?.status || ""
                    )
                  : "bg-gray-100 text-gray-800"
              }`}
            >
              {selectedProject &&
              surveyProjects.find((p) => p.id === selectedProject)?.status
                ? getStatusLabel(
                    surveyProjects.find((p) => p.id === selectedProject)
                      ?.status || ""
                  )
                : "ÏÉÅÌÉú ÏóÜÏùå"}
            </div>
          </div>
        </div>
      </div>

      {/* Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div className="flex-row gap-6">
          {/* ÏÉÅÎã® ÏÇ¨Ïù¥ÎìúÎ∞î - ÏÑ§Î¨∏ ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù */}
          <div className="w-full mb-6">
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">
                ÏÑ§Î¨∏ ÌîÑÎ°úÏ†ùÌä∏ Ï¥ù {surveyProjects.length}Í∞ú
              </h3>
              <div className="flex gap-2 w-full h-fit overflow-x-scroll">
                {surveyProjects.map((project) => (
                  <div
                    key={project.id}
                    className={`p-4 min-w-72 h-36 border rounded-lg cursor-pointer transition-all duration-200 ${
                      project.isSelected
                        ? "border-blue-500 bg-blue-50 shadow-md"
                        : "border-gray-200 hover:border-gray-300 hover:shadow-sm"
                    }`}
                    onClick={() => handleProjectSelect(project.id)}
                  >
                    <div className="flex items-start justify-between mb-2">
                      <h3
                        className={`w-3/4 font-medium truncate text-sm ${
                          project.isSelected ? "text-blue-900" : "text-gray-900"
                        }`}
                      >
                        {project.title}
                      </h3>
                      <span
                        className={`px-2 py-1 text-xs rounded-full ${getStatusStyle(
                          project.status
                        )}`}
                      >
                        {getStatusLabel(project.status)}
                      </span>
                    </div>

                    <div className="space-y-1 text-xs text-gray-600">
                      <p>{project.templateType}</p>
                      <p>ÏÉùÏÑ±Ïùº: {project.date}</p>
                    </div>

                    {project.isSelected && (
                      <div className="mt-3 pt-2 border-t border-blue-200">
                        <div className="flex items-center text-xs text-blue-600">
                          <div className="w-2 h-2 bg-blue-500 rounded-full mr-2"></div>
                          ÏÑ†ÌÉùÎê®
                        </div>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* ÌòÑÌô© ÌååÏïÖ */}
          <div className="flex-row">
            {/* ÏÑ§Î¨∏ Ï∞∏Ïó¨ ÌòÑÌô© ÏöîÏïΩ */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-6 text-center">
                {schoolName || "ÏôÄÏù¥Ï¶à Ï¥àÎì±ÌïôÍµê"} [{gradeLevel}ÌïôÎÖÑ{" "}
                {classNumber}Î∞ò]
              </h3>
              <div className="grid grid-cols-4 gap-8">
                {/* ÏÑ§Î¨∏ Ï∞∏Ïó¨ ÏòàÏÉÅ ÌïôÏÉù Ïàò */}
                <div className="flex flex-col items-center">
                  <div className="text-4xl font-bold text-blue-600 mb-2">
                    {participationData.totalStudents}
                  </div>
                  <div className="text-sm text-gray-600 text-center leading-tight">
                    ÏÑ§Î¨∏ Ï∞∏Ïó¨ ÏòàÏÉÅ
                    <br />
                    ÌïôÏÉù Ïàò
                  </div>
                </div>

                {/* Ï∞∏Ïó¨ ÌïôÏÉù Î∞òÏõêÌòï ÌîÑÎ°úÍ∑∏Î†àÏä§ */}
                <div className="flex flex-col items-center">
                  <div className="relative w-40 h-24 mb-2">
                    <svg className="w-full h-full" viewBox="0 0 100 50">
                      {/* Î∞∞Í≤Ω Î∞òÏõê */}
                      <path
                        d="M 10 40 A 40 40 0 0 1 90 40"
                        fill="none"
                        stroke="#e5e7eb"
                        strokeWidth="8"
                        strokeLinecap="round"
                      />
                      {/* ÏßÑÌñâÎ•† Î∞òÏõê */}
                      <path
                        d="M 10 40 A 40 40 0 0 1 90 40"
                        fill="none"
                        stroke="#10b981"
                        strokeWidth="8"
                        strokeLinecap="round"
                        strokeDasharray={125.6}
                        strokeDashoffset={
                          125.6 -
                          (participationData.participatedStudents /
                            participationData.totalStudents) *
                            125.6
                        }
                      />
                      {/* ÏãúÏûëÏ†êÍ≥º ÎÅùÏ†ê ÎùºÎ≤® */}
                      <text
                        x="7"
                        y="52"
                        textAnchor="start"
                        className="text-[8px] fill-gray-500"
                      >
                        0
                      </text>
                      <text
                        x="83"
                        y="52"
                        textAnchor="start"
                        className="text-[8px] fill-gray-500"
                      >
                        {participationData.participatedStudents}/
                        {participationData.totalStudents}
                      </text>
                    </svg>
                    {/* Ï§ëÏïô ÌÖçÏä§Ìä∏ */}
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className="text-lg font-bold text-gray-900">
                        {participationData.participatedStudents}Î™Ö
                      </span>
                    </div>
                  </div>
                  <div className="text-sm text-gray-600 text-center">
                    Ï∞∏Ïó¨ ÌïôÏÉù
                  </div>
                </div>

                {/* ÎØ∏Ï∞∏Ïó¨ ÌïôÏÉù Î∞òÏõêÌòï ÌîÑÎ°úÍ∑∏Î†àÏä§ */}
                <div className="flex flex-col items-center">
                  <div className="relative w-40 h-24 mb-2">
                    <svg className="w-full h-full" viewBox="0 0 100 50">
                      {/* Î∞∞Í≤Ω Î∞òÏõê */}
                      <path
                        d="M 10 40 A 40 40 0 0 1 90 40"
                        fill="none"
                        stroke="#e5e7eb"
                        strokeWidth="8"
                        strokeLinecap="round"
                      />
                      {/* ÏßÑÌñâÎ•† Î∞òÏõê */}
                      <path
                        d="M 10 40 A 40 40 0 0 1 90 40"
                        fill="none"
                        stroke="#6b7280"
                        strokeWidth="8"
                        strokeLinecap="round"
                        strokeDasharray={125.6}
                        strokeDashoffset={
                          125.6 -
                          (participationData.nonParticipatedStudents /
                            participationData.totalStudents) *
                            125.6
                        }
                      />
                      {/* ÏãúÏûëÏ†êÍ≥º ÎÅùÏ†ê ÎùºÎ≤® */}
                      <text
                        x="7"
                        y="52"
                        textAnchor="start"
                        className="text-[8px] fill-gray-500"
                      >
                        0
                      </text>
                      <text
                        x="79"
                        y="52"
                        textAnchor="start"
                        className="text-[8px] fill-gray-500"
                      >
                        {participationData.nonParticipatedStudents}/
                        {participationData.totalStudents}
                      </text>
                    </svg>
                    {/* Ï§ëÏïô ÌÖçÏä§Ìä∏ */}
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className="text-lg font-bold text-gray-900">
                        {participationData.nonParticipatedStudents}Î™Ö
                      </span>
                    </div>
                  </div>
                  <div className="text-sm text-gray-600 text-center">
                    ÎØ∏Ï∞∏Ïó¨ ÌïôÏÉù
                  </div>
                </div>

                {/* ÏßÑÌñâ ÏÉÅÌÉú Î∞òÏõêÌòï ÌîÑÎ°úÍ∑∏Î†àÏä§ */}
                <div className="flex flex-col items-center">
                  <div className="relative w-40 h-24 mb-2">
                    <svg className="w-full h-full" viewBox="0 0 100 50">
                      {/* Î∞∞Í≤Ω Î∞òÏõê */}
                      <path
                        d="M 10 40 A 40 40 0 0 1 90 40"
                        fill="none"
                        stroke="#e5e7eb"
                        strokeWidth="8"
                        strokeLinecap="round"
                      />
                      {/* ÏßÑÌñâÎ•† Î∞òÏõê */}
                      <path
                        d="M 10 40 A 40 40 0 0 1 90 40"
                        fill="none"
                        stroke="#8b5cf6"
                        strokeWidth="8"
                        strokeLinecap="round"
                        strokeDasharray={125.6}
                        strokeDashoffset={
                          125.6 -
                          (participationData.completionRate / 100) * 125.6
                        }
                      />
                      {/* ÏãúÏûëÏ†êÍ≥º ÎÅùÏ†ê ÎùºÎ≤® */}
                      <text
                        x="7"
                        y="52"
                        textAnchor="start"
                        className="text-[8px] fill-gray-500"
                      >
                        0
                      </text>
                      <text
                        x="80"
                        y="52"
                        textAnchor="start"
                        className="text-[8px] fill-gray-500"
                      >
                        {participationData.completionRate}%
                      </text>
                    </svg>
                    {/* Ï§ëÏïô ÌÖçÏä§Ìä∏ */}
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className="text-lg font-bold text-gray-900">
                        {participationData.completionRate}%
                      </span>
                    </div>
                  </div>
                  <div className="text-sm text-gray-600 text-center">
                    ÏßÑÌñâ ÏÉÅÌÉú
                  </div>
                </div>
              </div>
            </div>

            {/* Ï∞∏Ïó¨ ÌòÑÌô© Î¶¨Ïä§Ìä∏ */}
            <div className="bg-white w-full rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">
                Ï∞∏Ïó¨ ÌòÑÌô© Î¶¨Ïä§Ìä∏
              </h3>
              <div className="w-full overflow-x-auto">
                <table className="w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="min-w-[70px] max-w-[70px] px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Î≤àÌò∏
                      </th>
                      <th className="min-w-[94px] max-w-[94px] px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Ïù¥Î¶Ñ
                      </th>
                      <th className="min-w-[118px] max-w-[118px] px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Ï∞∏Ïó¨ÏÉÅÌÉú
                      </th>
                      {selectedProject &&
                        surveyProjects
                          .find((p) => p.id === selectedProject)
                          ?.questions?.map((question: any, index: number) => (
                            <th
                              key={question.id || index}
                              className="min-w-[176px] max-w-[176px] px-3 py-3 truncate text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                            >
                              {question.text || `ÏßàÎ¨∏ ${index + 1}`}
                            </th>
                          ))}
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {studentParticipationList.map((student) => (
                      <tr key={student.id} className="hover:bg-gray-50">
                        <td className="px-3 py-3 text-center whitespace-nowrap text-xs text-gray-900">
                          {student.id}
                        </td>
                        <td className="px-3 py-3 whitespace-nowrap text-xs font-medium text-gray-900">
                          {student.name}
                        </td>
                        <td className="px-3 py-3 text-center whitespace-nowrap">
                          <div className="flex  items-center">
                            <div
                              className={`w-3.5 h-3.5 mx-auto rounded-full ${
                                student.participated
                                  ? "bg-green-500"
                                  : "bg-gray-300"
                              }`}
                            ></div>
                          </div>
                        </td>
                        {selectedProject &&
                          surveyProjects
                            .find((p) => p.id === selectedProject)
                            ?.questions?.map((question: any, index: number) => {
                              // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÏÑ§Î¨∏Ïùò ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ìï¥Îãπ ÌïôÏÉùÏùò ÏùëÎãµ Ï∞æÍ∏∞
                              let questionResponse = "";

                              if (student.participated) {
                                // survey_responses ÌÖåÏù¥Î∏îÏóêÏÑú Ìï¥Îãπ ÏÑ§Î¨∏Í≥º ÌïôÏÉùÏùò ÏùëÎãµ Ï∞æÍ∏∞
                                const actualStudentId = students?.find(
                                  (s) => s.name === student.name
                                )?.id;

                                const studentResponse = responses?.find(
                                  (r: any) => r.student_id === actualStudentId
                                );

                                if (
                                  studentResponse &&
                                  studentResponse.responses
                                ) {
                                  try {
                                    const responseData =
                                      studentResponse.responses as any;

                                    // ÌòÑÏû¨ ÏÑ§Î¨∏Ïùò Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏù∏
                                    const currentProject = surveyProjects.find(
                                      (p) => p.id === selectedProject
                                    );
                                    const currentTemplate =
                                      surveyTemplates.find(
                                        (t) =>
                                          t.id === currentProject?.template_id
                                      );
                                    const category =
                                      currentTemplate?.metadata?.category;

                                    if (category === "ÍµêÏö∞Í¥ÄÍ≥Ñ") {
                                      // ÍµêÏö∞Í¥ÄÍ≥Ñ: ÌïôÏÉù Ïù¥Î¶ÑÏúºÎ°ú ÌëúÏãú
                                      if (
                                        responseData[question.id] &&
                                        Array.isArray(responseData[question.id])
                                      ) {
                                        // ÏùëÎãµÎêú ÏπúÍµ¨ IDÎì§ÏùÑ Ïã§Ï†ú Ïù¥Î¶ÑÏúºÎ°ú Î≥ÄÌôò
                                        const friendNames = responseData[
                                          question.id
                                        ]
                                          .map((friendId: string) => {
                                            const friend = students?.find(
                                              (s: any) => s.id === friendId
                                            );
                                            return friend
                                              ? friend.name
                                              : "Ïïå Ïàò ÏóÜÏùå";
                                          })
                                          .filter(
                                            (name: string) =>
                                              name !== "Ïïå Ïàò ÏóÜÏùå"
                                          );

                                        questionResponse =
                                          friendNames.join(", ");
                                      } else if (responseData[question.id]) {
                                        // Î∞∞Ïó¥Ïù¥ ÏïÑÎãå Îã®Ïùº Í∞íÏù∏ Í≤ΩÏö∞
                                        const friendId =
                                          responseData[question.id];
                                        const friend = students?.find(
                                          (s: any) => s.id === friendId
                                        );
                                        questionResponse = friend
                                          ? friend.name
                                          : "Ïïå Ïàò ÏóÜÏùå";
                                      } else {
                                        questionResponse = "ÏùëÎãµ ÏóÜÏùå";
                                      }
                                    } else {
                                      // ÌïôÍµêÌè≠Î†•, ÎßåÏ°±ÎèÑ: ÎãµÎ≥ÄÏòµÏÖòÏúºÎ°ú ÌëúÏãú
                                      const answerValue =
                                        responseData[question.id];
                                      if (answerValue) {
                                        // question.answer_optionsÏóêÏÑú ÎãµÎ≥Ä ÌÖçÏä§Ìä∏ Ï∞æÍ∏∞
                                        if (
                                          question.answer_options &&
                                          question.answer_options[answerValue]
                                        ) {
                                          questionResponse =
                                            question.answer_options[
                                              answerValue
                                            ];
                                        } else {
                                          questionResponse = `ÎãµÎ≥Ä: ${answerValue}`;
                                        }
                                      } else {
                                        questionResponse = "ÏùëÎãµ ÏóÜÏùå";
                                      }
                                    }
                                  } catch (e) {
                                    console.error("ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:", e);
                                    questionResponse = "ÌååÏã± Ïò§Î•ò";
                                  }
                                } else {
                                  questionResponse = "ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå";
                                }
                              }

                              return (
                                <td
                                  key={question.id || index}
                                  className="px-3 py-3 whitespace-nowrap text-xs text-gray-900"
                                >
                                  {questionResponse ||
                                    (student.participated ? "ÏùëÎãµ ÏóÜÏùå" : "")}
                                </td>
                              );
                            })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* ÏùºÎ≥Ñ Ï∞∏Ïó¨ ÌòÑÌô© */}
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">
                ÏùºÎ≥Ñ Ï∞∏Ïó¨ ÌòÑÌô©
              </h3>
              <BarChart data={dailyParticipationData} />
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Dashboard;
