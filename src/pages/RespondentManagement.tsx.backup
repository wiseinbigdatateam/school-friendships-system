import React, { useState, useEffect } from 'react';
import { StudentService, StudentWithAnalysis } from '../services/studentService';
import Papa from 'papaparse';
import { supabase } from '../utils/index';
import { useAuth } from '../contexts/AuthContext';
import * as XLSX from 'xlsx';

// CSV ì—…ë¡œë“œìš© í•™ìƒ ë°ì´í„° ì¸í„°í˜ì´ìŠ¤
interface StudentUploadData {
  í•™ë…„: string;
  ë°˜: string;
  ë²ˆí˜¸: string;
  ì´ë¦„: string;
  ì„±ë³„: string;
  ìƒë…„ì›”ì¼: string;
  ì…í•™ì¼: string;
  ì–´ë¨¸ë‹ˆëª…: string;
  ì–´ë¨¸ë‹ˆì—°ë½ì²˜: string;
  ì•„ë²„ì§€ëª…: string;
  ì•„ë²„ì§€ì—°ë½ì²˜: string;
  ì´ë©”ì¼: string;
}

// í•™ìƒ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
const StudentCard: React.FC<{
  student: StudentWithAnalysis;
  onViewDetails: (student: StudentWithAnalysis) => void;
  onAddMemo: (student: StudentWithAnalysis) => void;
}> = ({ student, onViewDetails, onAddMemo }) => {
  // parent_contactê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì•ˆì „í•˜ê²Œ ì ‘ê·¼
  // const parentContact = student.parent_contact as any;
  
  // ìœ„í—˜ë„ ê³„ì‚° (ë„¤íŠ¸ì›Œí¬ ë¶„ì„ ê²°ê³¼ ê¸°ë°˜)
  const analysisResult = student.network_analysis_results?.[0];
  const riskLevel = analysisResult?.risk_indicators ? 
    (analysisResult.risk_indicators as any)?.isolation_risk || 'low' : 'low';
  
  const getRiskColor = (risk: string) => {
    switch (risk) {
      case 'high': return 'bg-red-100 text-red-800';
      case 'medium': return 'bg-yellow-100 text-yellow-800';
      default: return 'bg-green-100 text-green-800';
    }
  };

  const getRiskLabel = (risk: string) => {
    switch (risk) {
      case 'high': return 'ì£¼ì˜ í•„ìš”';
      case 'medium': return 'ê´€ì°° ì¤‘';
      default: return 'ì•ˆì •';
    }
  };

  return (
    <div className="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow">
      <div className="flex items-start justify-between mb-4">
        <div className="flex items-center space-x-4">
          <div className="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
            <span className="text-white font-semibold">{student.name.charAt(0)}</span>
          </div>
          <div>
            <h3 className="text-lg font-semibold text-gray-900">{student.name}</h3>
            <p className="text-sm text-gray-600">{student.grade}í•™ë…„ {student.class}ë°˜ Â· {student.student_number}</p>
          </div>
        </div>
        
        <span className={`px-2 py-1 rounded-full text-xs font-medium ${getRiskColor(riskLevel)}`}>
          {getRiskLabel(riskLevel)}
        </span>
      </div>

      <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
        <div>
          <span className="text-gray-600">ì„±ë³„:</span>
          <span className="ml-2 text-gray-900">{student.gender === 'male' ? 'ë‚¨' : 'ì—¬'}</span>
        </div>
        <div>
          <span className="text-gray-600">ìƒë…„ì›”ì¼:</span>
          <span className="ml-2 text-gray-900">{student.birth_date}</span>
        </div>
        <div>
          <span className="text-gray-600">ì…í•™ì¼:</span>
          <span className="ml-2 text-gray-900">{new Date(student.enrolled_at).toLocaleDateString()}</span>
        </div>
        <div>
          <span className="text-gray-600">êµìœ¡ID:</span>
          <span className="ml-2 text-gray-900">{student.lifelong_education_id}</span>
        </div>
      </div>

      {/* ë„¤íŠ¸ì›Œí¬ ë¶„ì„ ì •ë³´ */}
      {analysisResult && (
        <div className="mb-4 p-3 bg-gray-50 rounded-lg">
          <h4 className="text-sm font-medium text-gray-700 mb-2">êµìš°ê´€ê³„ ë¶„ì„</h4>
          <div className="grid grid-cols-2 gap-2 text-xs">
            <div>
              <span className="text-gray-600">ì¤‘ì‹¬ì„±:</span>
              <span className="ml-2 text-gray-900">
                {analysisResult.centrality_scores ? 
                  Math.round(((analysisResult.centrality_scores as any)?.degree || 0) * 100) / 100 : 'N/A'}
              </span>
            </div>
            <div>
              <span className="text-gray-600">ì†Œì† ê·¸ë£¹:</span>
              <span className="ml-2 text-gray-900">{analysisResult.community_membership || 'N/A'}</span>
            </div>
          </div>
        </div>
      )}

      {/* ë©”ëª¨ ìˆ˜ */}
      <div className="mb-4 text-sm">
        <span className="text-gray-600">êµì‚¬ ë©”ëª¨:</span>
        <span className="ml-2 text-gray-900">{student.teacher_memos?.length || 0}ê°œ</span>
        <span className="ml-4 text-gray-600">ê°œì… ê¸°ë¡:</span>
        <span className="ml-2 text-gray-900">{student.intervention_logs?.length || 0}ê°œ</span>
      </div>

      <div className="flex space-x-2">
        <button
          onClick={() => onViewDetails(student)}
          className="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-blue-700 transition-colors"
        >
          ìƒì„¸ë³´ê¸°
        </button>
        <button
          onClick={() => onAddMemo(student)}
          className="bg-gray-100 text-gray-700 py-2 px-4 rounded-md text-sm font-medium hover:bg-gray-200 transition-colors"
        >
          ë©”ëª¨ ì¶”ê°€
        </button>
      </div>
    </div>
  );
};

// í•™ìƒ ìƒì„¸ ì •ë³´ ëª¨ë‹¬
const StudentDetailModal: React.FC<{
  student: StudentWithAnalysis | null;
  isOpen: boolean;
  onClose: () => void;
}> = ({ student, isOpen, onClose }) => {
  if (!isOpen || !student) return null;

  const parentContact = student.parent_contact as any;
  const analysisResult = student.network_analysis_results?.[0];

  // ë””ë²„ê¹…: í•™ë¶€ëª¨ ì—°ë½ì²˜ ì •ë³´ ë¡œê·¸
  console.log('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ í•™ìƒ ìƒì„¸ë³´ê¸° - í•™ë¶€ëª¨ ì—°ë½ì²˜:', {
    studentId: student.id,
    studentName: student.name,
    parent_contact: student.parent_contact,
    parentContact: parentContact
  });

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div className="flex items-center justify-between mb-6">
          <h2 className="text-2xl font-bold text-gray-900">{student.name} ìƒì„¸ ì •ë³´</h2>
          <button
            onClick={onClose}
            className="text-gray-500 hover:text-gray-700"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* ê¸°ë³¸ ì •ë³´ */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold text-gray-900">ê¸°ë³¸ ì •ë³´</h3>
            <div className="bg-gray-50 rounded-lg p-4">
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="font-medium text-gray-600">í•™ë²ˆ:</span>
                  <span className="ml-2 text-gray-900">{student.student_number}</span>
                </div>
                <div>
                  <span className="font-medium text-gray-600">í•™ê¸‰:</span>
                  <span className="ml-2 text-gray-900">{student.grade}í•™ë…„ {student.class}ë°˜</span>
                </div>
                <div>
                  <span className="font-medium text-gray-600">ì„±ë³„:</span>
                  <span className="ml-2 text-gray-900">{student.gender === 'male' ? 'ë‚¨ì' : 'ì—¬ì'}</span>
                </div>
                <div>
                  <span className="font-medium text-gray-600">ìƒë…„ì›”ì¼:</span>
                  <span className="ml-2 text-gray-900">{student.birth_date}</span>
                </div>
                <div className="col-span-2">
                  <span className="font-medium text-gray-600">êµìœ¡ ID:</span>
                  <span className="ml-2 text-gray-900">{student.lifelong_education_id}</span>
                </div>
                <div className="col-span-2">
                  <span className="font-medium text-gray-600">ì…í•™ì¼:</span>
                  <span className="ml-2 text-gray-900">{new Date(student.enrolled_at).toLocaleDateString()}</span>
                </div>
              </div>
            </div>

            {/* í•™ë¶€ëª¨ ì—°ë½ì²˜ */}
            <h3 className="text-lg font-semibold text-gray-900">í•™ë¶€ëª¨ ì—°ë½ì²˜</h3>
            <div className="bg-gray-50 rounded-lg p-4">
              {/* ì–´ë¨¸ë‹ˆ ì •ë³´ */}
              {parentContact?.motherName && (
                <div className="mb-3 p-3 bg-pink-50 rounded-lg">
                  <h4 className="text-sm font-medium text-pink-700 mb-2">ì–´ë¨¸ë‹ˆ</h4>
                  <div className="space-y-1">
                    <div>
                      <span className="text-sm font-medium text-gray-600">ì´ë¦„:</span>
                      <span className="ml-2 text-sm text-gray-900">{parentContact.motherName}</span>
                    </div>
                    {parentContact?.motherPhone && (
                      <div>
                        <span className="text-sm font-medium text-gray-600">ì—°ë½ì²˜:</span>
                        <span className="ml-2 text-sm text-gray-900">{parentContact.motherPhone}</span>
                      </div>
                    )}
                  </div>
                </div>
              )}
              
              {/* ì•„ë²„ì§€ ì •ë³´ */}
              {parentContact?.fatherName && (
                <div className="mb-3 p-3 bg-blue-50 rounded-lg">
                  <h4 className="text-sm font-medium text-blue-700 mb-2">ì•„ë²„ì§€</h4>
                  <div className="space-y-1">
                    <div>
                      <span className="text-sm font-medium text-gray-600">ì´ë¦„:</span>
                      <span className="ml-2 text-sm text-gray-900">{parentContact.fatherName}</span>
                    </div>
                    {parentContact?.fatherPhone && (
                      <div>
                        <span className="text-sm font-medium text-gray-600">ì—°ë½ì²˜:</span>
                        <span className="ml-2 text-sm text-gray-900">{parentContact.fatherPhone}</span>
                      </div>
                    )}
                  </div>
                </div>
              )}
              
              {/* ì´ë©”ì¼ ì •ë³´ */}
              {parentContact?.email && (
                <div className="mb-3 p-3 bg-purple-50 rounded-lg">
                  <h4 className="text-sm font-medium text-purple-700 mb-2">ì—°ë½ì²˜</h4>
                  <div>
                    <span className="text-sm font-medium text-gray-600">ì´ë©”ì¼:</span>
                    <span className="ml-2 text-sm text-gray-900">{parentContact.email}</span>
                  </div>
                </div>
              )}
              
              {/* ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° */}
              {!parentContact?.motherName && !parentContact?.fatherName && !parentContact?.email && (
                <div className="text-sm text-gray-500 italic text-center py-4">
                  í•™ë¶€ëª¨ ì—°ë½ì²˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
              )}
            </div>
          </div>

          {/* ë„¤íŠ¸ì›Œí¬ ë¶„ì„ ê²°ê³¼ */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold text-gray-900">êµìš°ê´€ê³„ ë¶„ì„</h3>
            {analysisResult ? (
              <div className="bg-gray-50 rounded-lg p-4">
                <div className="space-y-3">
                  <div>
                    <h4 className="text-sm font-medium text-gray-700">ì¤‘ì‹¬ì„± ì§€ìˆ˜</h4>
                    <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                      {analysisResult.centrality_scores && (
                        <>
                          <div>
                            <span className="text-gray-600">ì—°ê²° ì¤‘ì‹¬ì„±:</span>
                            <span className="ml-2 text-gray-900">
                              {Math.round(((analysisResult.centrality_scores as any)?.degree || 0) * 100) / 100}
                            </span>
                          </div>
                          <div>
                            <span className="text-gray-600">ê·¼ì ‘ ì¤‘ì‹¬ì„±:</span>
                            <span className="ml-2 text-gray-900">
                              {Math.round(((analysisResult.centrality_scores as any)?.closeness || 0) * 100) / 100}
                            </span>
                          </div>
                          <div>
                            <span className="text-gray-600">ë§¤ê°œ ì¤‘ì‹¬ì„±:</span>
                            <span className="ml-2 text-gray-900">
                              {Math.round(((analysisResult.centrality_scores as any)?.betweenness || 0) * 100) / 100}
                            </span>
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                  
                  <div>
                    <h4 className="text-sm font-medium text-gray-700">ì†Œì† ê·¸ë£¹</h4>
                    <p className="text-sm text-gray-900 mt-1">{analysisResult.community_membership || 'ë¯¸ë¶„ë¥˜'}</p>
                  </div>
                  
                  {analysisResult.risk_indicators && (
                    <div>
                      <h4 className="text-sm font-medium text-gray-700">ìœ„í—˜ ì§€í‘œ</h4>
                      <div className="mt-2 text-sm">
                        <span className="text-gray-600">ê³ ë¦½ ìœ„í—˜ë„:</span>
                        <span className="ml-2 text-gray-900">
                          {(analysisResult.risk_indicators as any)?.isolation_risk || 'low'}
                        </span>
                      </div>
                    </div>
                  )}
                  
                  {analysisResult.recommendations && (
                    <div>
                      <h4 className="text-sm font-medium text-gray-700">ê¶Œì¥ì‚¬í•­</h4>
                      <p className="text-sm text-gray-900 mt-1">
                        {(analysisResult.recommendations as any)?.intervention || 'ì •ê¸° ê´€ì°°'}
                      </p>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="bg-gray-50 rounded-lg p-4">
                <p className="text-sm text-gray-500">ì•„ì§ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            )}

            {/* êµì‚¬ ë©”ëª¨ */}
            <h3 className="text-lg font-semibold text-gray-900">êµì‚¬ ë©”ëª¨</h3>
            <div className="bg-gray-50 rounded-lg p-4 max-h-48 overflow-y-auto">
              {student.teacher_memos && student.teacher_memos.length > 0 ? (
                <div className="space-y-2">
                  {student.teacher_memos.map((memo) => (
                    <div key={memo.id} className="text-sm">
                      <div className="flex justify-between items-start">
                        <span className="font-medium text-gray-700">{memo.memo_type}</span>
                        <span className="text-xs text-gray-500">
                          {new Date(memo.created_at || '').toLocaleDateString()}
                        </span>
                      </div>
                      <p className="text-gray-900 mt-1">{memo.content}</p>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-sm text-gray-500">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const RespondentManagement: React.FC = () => {
  const { user } = useAuth(); // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´
  const [students, setStudents] = useState<StudentWithAnalysis[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');
  const [gradeFilter, setGradeFilter] = useState<string>('all');
  const [classFilter, setClassFilter] = useState<string>('all');
  const [riskFilter, setRiskFilter] = useState<string>('all');
  const [selectedStudent, setSelectedStudent] = useState<StudentWithAnalysis | null>(null);
  const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // ìƒ˜í”Œ ë°ì´í„° ìƒì„± í•¨ìˆ˜
  const generateSampleStudents = (): StudentWithAnalysis[] => {
    const names = ['ê¹€ë¯¼ìˆ˜', 'ì´ì§€ì˜', 'ë°•ì¤€í˜¸', 'ìµœì„œì—°', 'ì •ë‹¤ì€', 'ê°•íƒœí˜„'];
    const grades = ['1', '2', '3'];
    const classes = ['1', '2', '3'];
    
    return Array.from({ length: 6 }, (_, index) => ({
      id: `student-${index + 1}`,
      lifelong_education_id: `LEI-${String(index + 1).padStart(6, '0')}`,
      current_school_id: '00000000-0000-0000-0000-000000000011',
      student_number: String(index + 1).padStart(4, '0'),
      name: names[index],
      birth_date: `2010-0${(index % 12) + 1}-15`,
      gender: index % 2 === 0 ? 'male' : 'female',
      grade: grades[Math.floor(index / 2)],
      class: classes[index % 3],
      parent_contact: {
        mother: {
          name: 'ê¹€â—‹â—‹',
          phone: `010-1111-${String(index + 1).padStart(4, '0')}`
        }
      },
      enrolled_at: '2021-03-01T00:00:00Z',
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      is_active: true,
      network_analysis_results: [{
        id: `analysis-${index + 1}`,
        survey_id: 'survey-1',
        student_id: `student-${index + 1}`,
        analysis_type: 'friendship_network',
        centrality_scores: {
          degree: Math.floor(Math.random() * 15) + 5,
          betweenness: Math.random(),
          closeness: Math.random(),
          eigenvector: Math.random()
        },
        community_membership: `group_${Math.floor(Math.random() * 5) + 1}`,
        risk_indicators: {
          isolation_risk: Math.random() > 0.7 ? 'high' : Math.random() > 0.4 ? 'medium' : 'low',
          popularity: Math.random() * 10
        },
        recommendations: {
          intervention: Math.random() > 0.7 ? 'enhanced_monitoring' : 'routine'
        },
        calculated_at: new Date().toISOString()
      }],
      teacher_memos: [],
      intervention_logs: []
    }));
  };

  // ì‹¤ì œ í•™ìƒ ë°ì´í„° ë¡œë“œ
  useEffect(() => {
    const loadStudents = async () => {
      if (!user) return;
      
      try {
        setLoading(true);
        setError(null);
        
        // ë””ë²„ê¹…: ì‚¬ìš©ì ì •ë³´ ë¡œê·¸
        console.log('ğŸ” ì‚¬ìš©ì ì •ë³´:', {
          id: user.id,
          name: user.name,
          role: user.role,
          schoolId: user.schoolId,
          school_id: user.school_id,
          grade: user.grade,
          class: user.class
        });
        
        const schoolId = user.school_id || '00000000-0000-0000-0000-000000000011';
        
        let studentsData: StudentWithAnalysis[];
        
        // ë‹´ì„ì„ ìƒë‹˜ì¸ ê²½ìš° ìì‹ ì˜ ë‹´ë‹¹ ë°˜ í•™ìƒë§Œ ì¡°íšŒ
        if (user.role === 'homeroom_teacher' && user.grade && user.class) {
          // ë‹´ì„ì„ ìƒë‹˜ì€ ìì‹ ì˜ ë‹´ë‹¹ ë°˜ë§Œ ë³¼ ìˆ˜ ìˆìŒ
          if (searchTerm) {
            studentsData = await StudentService.searchStudents(schoolId, searchTerm);
            // ê²€ìƒ‰ ê²°ê³¼ì—ì„œë„ ìì‹ ì˜ ë°˜ë§Œ í•„í„°ë§
            studentsData = studentsData.filter(student => 
              student.grade === user.grade && student.class === user.class
            );
          } else {
            studentsData = await StudentService.getStudentsByGradeAndClass(
              schoolId,
              user.grade,
              user.class
            );
          }
        } else {
          // í•™êµê´€ë¦¬ì, í•™ë…„ë¶€ì¥, êµìœ¡ì²­ê´€ë¦¬ìëŠ” ì „ì²´ ë˜ëŠ” í•„í„°ëœ ë°ì´í„° ì¡°íšŒ
          if (searchTerm) {
            studentsData = await StudentService.searchStudents(schoolId, searchTerm);
          } else if (gradeFilter !== 'all' || classFilter !== 'all') {
            studentsData = await StudentService.getStudentsByGradeAndClass(
              schoolId,
              gradeFilter !== 'all' ? gradeFilter : undefined,
              classFilter !== 'all' ? classFilter : undefined
            );
          } else if (riskFilter === 'high') {
            studentsData = await StudentService.getHighRiskStudents(schoolId);
          } else {
            studentsData = await StudentService.getAllStudents(schoolId);
          }
          
          // í•™ë…„ë¶€ì¥ì¸ ê²½ìš° ìì‹ ì˜ ë‹´ë‹¹ í•™ë…„ë§Œ í•„í„°ë§
          if (user.role === 'grade_teacher' && user.grade) {
            studentsData = studentsData.filter(student => student.grade === user.grade);
          }
        }
        
        setStudents(studentsData);
      } catch (error) {
        console.error('Failed to load students:', error);
        setError('í•™ìƒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
        
        // ì—ëŸ¬ ë°œìƒ ì‹œ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš© (ê¶Œí•œì— ë”°ë¼ í•„í„°ë§)
        let sampleStudents = generateSampleStudents();
        
        if (user.role === 'homeroom_teacher' && user.grade && user.class) {
          sampleStudents = sampleStudents.filter(student => 
            student.grade === user.grade && student.class === user.class
          );
        } else if (user.role === 'grade_teacher' && user.grade) {
          sampleStudents = sampleStudents.filter(student => student.grade === user.grade);
        }
        
        setStudents(sampleStudents);
      } finally {
        setLoading(false);
      }
    };

    loadStudents();
  }, [user, searchTerm, gradeFilter, classFilter, riskFilter]);

  const handleViewDetails = (student: StudentWithAnalysis) => {
    setSelectedStudent(student);
    setIsDetailModalOpen(true);
  };

  const handleAddMemo = async (student: StudentWithAnalysis) => {
    try {
      const content = prompt('í•™ìƒì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
      if (!content) return;

      const teacherId = '00000000-0000-0000-0000-000000000021'; // ì„ì‹œ êµì‚¬ ID
      
      await StudentService.addTeacherMemo(
        student.id,
        teacherId,
        content,
        'observation',
        'private'
      );

      // ë©”ëª¨ ì¶”ê°€ í›„ í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      if (!user) {
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      const schoolId = user.school_id || '00000000-0000-0000-0000-000000000011';
      const updatedStudents = await StudentService.getAllStudents(schoolId);
      setStudents(updatedStudents);
      
      alert('ë©”ëª¨ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error) {
      console.error('Failed to add memo:', error);
      alert('ë©”ëª¨ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  };

  const handleDownloadTemplate = () => {
    // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
    const headers = ['í•™ë…„', 'ë°˜', 'ë²ˆí˜¸', 'ì´ë¦„', 'ì„±ë³„', 'ìƒë…„ì›”ì¼', 'ì…í•™ì¼', 'ì–´ë¨¸ë‹ˆëª…', 'ì–´ë¨¸ë‹ˆì—°ë½ì²˜', 'ì•„ë²„ì§€ëª…', 'ì•„ë²„ì§€ì—°ë½ì²˜', 'ì´ë©”ì¼'];
    
    const sampleData = [
      ['3', '1', '1', 'ê¹€ì² ìˆ˜', 'ë‚¨', '2010-03-15', '2023-03-01', 'ê¹€â—‹â—‹', '010-1234-5678', 'ê¹€â—‹â—‹', '010-1111-1111', 'family1@email.com'],
      ['3', '1', '2', 'ì´ì˜í¬', 'ì—¬', '2010-05-20', '2023-03-01', 'ì´â—‹â—‹', '010-2345-6789', 'ì´â—‹â—‹', '010-2222-2222', 'family2@email.com'],
      ['3', '1', '3', 'ë°•ë¯¼ìˆ˜', 'ë‚¨', '2010-07-10', '2023-03-01', 'ë°•â—‹â—‹', '010-3456-7890', 'ë°•â—‹â—‹', '010-3333-3333', 'family3@email.com'],
      ['3', '1', '4', 'ìµœì§€ìš°', 'ì—¬', '2010-04-22', '2023-03-01', 'ìµœâ—‹â—‹', '010-4567-8901', 'ìµœâ—‹â—‹', '010-4444-4444', 'family4@email.com'],
      ['3', '1', '5', 'ì •í•˜ì€', 'ì—¬', '2010-08-05', '2023-03-01', 'ì •â—‹â—‹', '010-5678-9012', 'ì •â—‹â—‹', '010-5555-5555', 'family5@email.com'],
      ['3', '1', '6', 'ê°•ë„ìœ¤', 'ë‚¨', '2010-12-30', '2023-03-01', 'ê°•â—‹â—‹', '010-6789-0123', 'ê°•â—‹â—‹', '010-6666-6666', 'family6@email.com'],
      ['3', '1', '7', 'ìœ¤ì„œì—°', 'ì—¬', '2010-02-18', '2023-03-01', 'ìœ¤â—‹â—‹', '010-7890-1234', 'ìœ¤â—‹â—‹', '010-7777-7777', 'family7@email.com'],
      ['3', '1', '8', 'ì¥ë¯¼í˜¸', 'ë‚¨', '2010-09-11', '2023-03-01', 'ì¥â—‹â—‹', '010-8901-2345', 'ì¥â—‹â—‹', '010-8888-8888', 'family8@email.com']
    ];

    // ì›Œí¬ë¶ ìƒì„±
    const workbook = XLSX.utils.book_new();
    
    // ì›Œí¬ì‹œíŠ¸ ìƒì„±
    const worksheet = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
    
    // ì—´ ë„ˆë¹„ ìë™ ì¡°ì •
    const columnWidths = headers.map(header => ({ wch: Math.max(header.length, 15) }));
    worksheet['!cols'] = columnWidths;
    
    // ì›Œí¬ë¶ì— ì›Œí¬ì‹œíŠ¸ ì¶”ê°€
    XLSX.utils.book_append_sheet(workbook, worksheet, 'í•™ìƒëª…ë‹¨');
    
    // ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    XLSX.writeFile(workbook, 'í•™ìƒëª…ë‹¨_í…œí”Œë¦¿.xlsx');
  };

    const handleExcelUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    try {
      setLoading(true);
      
      let studentData: StudentUploadData[] = [];
      
      // íŒŒì¼ í™•ì¥ìì— ë”°ë¼ ì²˜ë¦¬ ë°©ì‹ ê²°ì •
      if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
        // ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        // ì²« ë²ˆì§¸ í–‰ì„ í—¤ë”ë¡œ ì‚¬ìš©í•˜ê³  ë‚˜ë¨¸ì§€ë¥¼ ë°ì´í„°ë¡œ ë³€í™˜
        const headers = jsonData[0] as string[];
        const dataRows = jsonData.slice(1) as string[][];
        
        studentData = dataRows.map(row => ({
          í•™ë…„: row[0] || '',
          ë°˜: row[1] || '',
          ë²ˆí˜¸: row[2] || '',
          ì´ë¦„: row[3] || '',
          ì„±ë³„: row[4] || '',
          ìƒë…„ì›”ì¼: row[5] || '',
          ì…í•™ì¼: row[6] || '',
          ì–´ë¨¸ë‹ˆëª…: row[7] || '',
          ì–´ë¨¸ë‹ˆì—°ë½ì²˜: row[8] || '',
          ì•„ë²„ì§€ëª…: row[9] || '',
          ì•„ë²„ì§€ì—°ë½ì²˜: row[10] || '',
          ì´ë©”ì¼: row[11] || ''
        }));
        
        // ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ í›„ ë°ì´í„° ê²€ì¦ ë° ì €ì¥
        await processStudentData(studentData);
        
      } else if (file.name.endsWith('.csv')) {
        // CSV íŒŒì¼ ì²˜ë¦¬ (ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
        Papa.parse(file, {
          header: true,
          encoding: 'UTF-8',
          complete: async (results) => {
            try {
              const csvStudentData = results.data as StudentUploadData[];
              await processStudentData(csvStudentData);
            } catch (parseError) {
              console.error('CSV parsing error:', parseError);
              alert('CSV íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
              setLoading(false);
            }
          },
          error: (error) => {
            console.error('CSV file error:', error);
            alert('CSV íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            setLoading(false);
          }
        });
      } else {
        alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. .xlsx, .xls, .csv íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        setLoading(false);
        return;
      }
      
    } catch (error) {
      console.error('File upload error:', error);
      alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      setLoading(false);
    }
    
    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
    event.target.value = '';
  };

  // í•™ìƒ ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ (ê³µí†µ ë¡œì§)
  const processStudentData = async (studentData: StudentUploadData[]) => {
    try {
      // ë°ì´í„° ê²€ì¦
      const validStudents = studentData.filter(student => 
        student.í•™ë…„ && student.ë°˜ && student.ë²ˆí˜¸ && student.ì´ë¦„ && student.ì„±ë³„ && student.ìƒë…„ì›”ì¼ && student.ì…í•™ì¼
      );

      if (validStudents.length === 0) {
        alert('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n- í—¤ë”ê°€ ì •í™•í•œì§€ (í•™ë…„,ë°˜,ë²ˆí˜¸,ì´ë¦„,ì„±ë³„,ìƒë…„ì›”ì¼,ì…í•™ì¼,ì–´ë¨¸ë‹ˆëª…,ì–´ë¨¸ë‹ˆì—°ë½ì²˜,ì•„ë²„ì§€ëª…,ì•„ë²„ì§€ì—°ë½ì²˜,ì´ë©”ì¼)\n- í•„ìˆ˜ í•­ëª©ì´ ëª¨ë‘ ì…ë ¥ë˜ì—ˆëŠ”ì§€\n- íŒŒì¼ì´ UTF-8ë¡œ ì €ì¥ë˜ì—ˆëŠ”ì§€');
        setLoading(false);
        return;
      }

      // ì¤‘ë³µ í•™ë²ˆ ê²€ì‚¬
      const duplicateCheck = new Set();
      const duplicates = [];
      
      for (const student of validStudents) {
        const key = `${student.í•™ë…„}-${student.ë°˜}-${student.ë²ˆí˜¸}`;
        if (duplicateCheck.has(key)) {
          duplicates.push(`${student.í•™ë…„}í•™ë…„ ${student.ë°˜}ë°˜ ${student.ë²ˆí˜¸}ë²ˆ`);
        }
        duplicateCheck.add(key);
      }

      if (duplicates.length > 0) {
        alert(`ì¤‘ë³µëœ í•™ë²ˆì´ ìˆìŠµë‹ˆë‹¤:\n${duplicates.join(', ')}\n\nì¤‘ë³µì„ ì œê±°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
        setLoading(false);
        return;
      }

      // í˜„ì¬ í•™êµ ID (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ í•™êµ ID ì‚¬ìš©)
      if (!user) {
        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        setLoading(false);
        return;
      }
      
      // ë””ë²„ê¹…: ì—…ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë¡œê·¸
      console.log('ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´:', {
        id: user.id,
        name: user.name,
        role: user.role,
        schoolId: user.schoolId,
        school_id: user.school_id,
        grade: user.grade,
        class: user.class
      });
      
      const schoolId = user.school_id || '00000000-0000-0000-0000-000000000011';

      // í•™ìƒ ë°ì´í„°ë¥¼ Supabase í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const studentsToInsert = validStudents.map((student, index) => ({
        lifelong_education_id: `LEI-${Date.now()}-${index}`, // ì„ì‹œ LEI ìƒì„±
        current_school_id: schoolId,
        student_number: student.ë²ˆí˜¸,
        name: student.ì´ë¦„,
        birth_date: student.ìƒë…„ì›”ì¼,
        gender: student.ì„±ë³„ === 'ë‚¨' ? 'male' : 'female',
        grade: student.grade,
        class: student.ë°˜,
        parent_contact: {
          motherName: student.ì–´ë¨¸ë‹ˆëª… || '',
          motherPhone: student.ì–´ë¨¸ë‹ˆì—°ë½ì²˜ || '',
          fatherName: student.ì•„ë²„ì§€ëª… || '',
          fatherPhone: student.ì•„ë²„ì§€ì—°ë½ì²˜ || '',
          email: student.ì´ë©”ì¼ || ''
        },
        enrolled_at: student.ì…í•™ì¼, // CSVì˜ ì…í•™ì¼ ì»¬ëŸ¼ ê°’ ì‚¬ìš©
        is_active: true
      }));

      // Supabaseì— ì¼ê´„ ì‚½ì…
      const { error } = await supabase
        .from('students')
        .insert(studentsToInsert)
        .select();

      if (error) {
        console.error('Database insert error:', error);
        alert(`ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
        setLoading(false);
        return;
      }

      // ì„±ê³µ ë©”ì‹œì§€
      const gradeClassSummary = Array.from(new Set(validStudents.map(s => `${s.í•™ë…„}í•™ë…„ ${s.ë°˜}ë°˜`))).join(', ');
      alert(`âœ… í•™ìƒ ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!\n\nâ€¢ ì €ì¥ëœ í•™ìƒ ìˆ˜: ${validStudents.length}ëª…\nâ€¢ ëŒ€ìƒ í•™ê¸‰: ${gradeClassSummary}\nâ€¢ ì²˜ë¦¬ëœ ì‹œê°„: ${new Date().toLocaleString()}`);
      
      // í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      const updatedStudents = await StudentService.getAllStudents(schoolId);
      setStudents(updatedStudents);
      
    } catch (error) {
      console.error('Data processing error:', error);
      alert('ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setLoading(false);
    }
  };
            
            // ë°ì´í„° ê²€ì¦
            const validStudents = studentData.filter(student => 
              student.í•™ë…„ && student.ë°˜ && student.ë²ˆí˜¸ && student.ì´ë¦„ && student.ì„±ë³„ && student.ìƒë…„ì›”ì¼ && student.ì…í•™ì¼
            );

            if (validStudents.length === 0) {
              alert('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n- í—¤ë”ê°€ ì •í™•í•œì§€ (í•™ë…„,ë°˜,ë²ˆí˜¸,ì´ë¦„,ì„±ë³„,ìƒë…„ì›”ì¼,ì…í•™ì¼,ì–´ë¨¸ë‹ˆëª…,ì–´ë¨¸ë‹ˆì—°ë½ì²˜,ì•„ë²„ì§€ëª…,ì•„ë²„ì§€ì—°ë½ì²˜,ì´ë©”ì¼)\n- í•„ìˆ˜ í•­ëª©ì´ ëª¨ë‘ ì…ë ¥ë˜ì—ˆëŠ”ì§€\n- íŒŒì¼ì´ UTF-8ë¡œ ì €ì¥ë˜ì—ˆëŠ”ì§€');
              return;
            }

            // ì¤‘ë³µ í•™ë²ˆ ê²€ì‚¬
            const duplicateCheck = new Set();
            const duplicates = [];
            
            for (const student of validStudents) {
              const key = `${student.í•™ë…„}-${student.ë°˜}-${student.ë²ˆí˜¸}`;
              if (duplicateCheck.has(key)) {
                duplicates.push(`${student.í•™ë…„}í•™ë…„ ${student.ë°˜}ë°˜ ${student.ë²ˆí˜¸}ë²ˆ`);
              }
              duplicateCheck.add(key);
            }

            if (duplicates.length > 0) {
              alert(`ì¤‘ë³µëœ í•™ë²ˆì´ ìˆìŠµë‹ˆë‹¤:\n${duplicates.join(', ')}\n\nì¤‘ë³µì„ ì œê±°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
              return;
            }

            // í˜„ì¬ í•™êµ ID (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ í•™êµ ID ì‚¬ìš©)
            if (!user) {
              alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
              return;
            }
            
            // ë””ë²„ê¹…: ì—…ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ë¡œê·¸
            console.log('ğŸ“¤ CSV ì—…ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´:', {
              id: user.id,
              name: user.name,
              role: user.role,
              schoolId: user.schoolId,
              school_id: user.school_id,
              grade: user.grade,
              class: user.class
            });
            
            const schoolId = user.school_id || '00000000-0000-0000-0000-000000000011';

            // í•™ìƒ ë°ì´í„°ë¥¼ Supabase í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const studentsToInsert = validStudents.map((student, index) => ({
              lifelong_education_id: `LEI-${Date.now()}-${index}`, // ì„ì‹œ LEI ìƒì„±
              current_school_id: schoolId,
              student_number: student.ë²ˆí˜¸,
              name: student.ì´ë¦„,
              birth_date: student.ìƒë…„ì›”ì¼,
              gender: student.ì„±ë³„ === 'ë‚¨' ? 'male' : 'female',
              grade: student.í•™ë…„,
              class: student.ë°˜,
              parent_contact: {
                motherName: student.ì–´ë¨¸ë‹ˆëª… || '',
                motherPhone: student.ì–´ë¨¸ë‹ˆì—°ë½ì²˜ || '',
                fatherName: student.ì•„ë²„ì§€ëª… || '',
                fatherPhone: student.ì•„ë²„ì§€ì—°ë½ì²˜ || '',
                email: student.ì´ë©”ì¼ || ''
              },
              enrolled_at: student.ì…í•™ì¼, // CSVì˜ ì…í•™ì¼ ì»¬ëŸ¼ ê°’ ì‚¬ìš©
              is_active: true
            }));

            // Supabaseì— ì¼ê´„ ì‚½ì…
            const { error } = await supabase
              .from('students')
              .insert(studentsToInsert)
              .select();

            if (error) {
              console.error('Database insert error:', error);
              alert(`ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`);
              return;
            }

            // ì„±ê³µ ë©”ì‹œì§€
            const gradeClassSummary = Array.from(new Set(validStudents.map(s => `${s.í•™ë…„}í•™ë…„ ${s.ë°˜}ë°˜`))).join(', ');
            alert(`âœ… í•™ìƒ ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!\n\nâ€¢ ì €ì¥ëœ í•™ìƒ ìˆ˜: ${validStudents.length}ëª…\nâ€¢ ëŒ€ìƒ í•™ê¸‰: ${gradeClassSummary}\nâ€¢ ì²˜ë¦¬ëœ ì‹œê°„: ${new Date().toLocaleString()}`);
            
            // í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            const updatedStudents = await StudentService.getAllStudents(schoolId);
            setStudents(updatedStudents);
            
          } catch (parseError) {
            console.error('Data processing error:', parseError);
            alert('ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          } finally {
            setLoading(false);
          }
        },
        error: (error) => {
          console.error('File parsing error:', error);
          alert('íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. CSV í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          setLoading(false);
        }
      });
      
      // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
      event.target.value = '';
    } catch (error) {
      console.error('Failed to upload file:', error);
      alert('íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      setLoading(false);
    }
  };

  const filteredStudents = students.filter(student => {
    const matchesSearch = student.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         student.student_number.includes(searchTerm);
    const matchesGrade = gradeFilter === 'all' || student.grade === gradeFilter;
    const matchesClass = classFilter === 'all' || student.class === classFilter;
    
    let matchesRisk = true;
    if (riskFilter !== 'all') {
      const analysisResult = student.network_analysis_results?.[0];
      const riskLevel = analysisResult?.risk_indicators ? 
        (analysisResult.risk_indicators as any)?.isolation_risk || 'low' : 'low';
      matchesRisk = riskLevel === riskFilter;
    }
    
    return matchesSearch && matchesGrade && matchesClass && matchesRisk;
  });

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-lg font-medium text-gray-900 mb-2">í•™ìƒ ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
          <p className="text-gray-600">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto">
        {/* í—¤ë” */}
        <div className="mb-8">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold text-gray-900 mb-2">í•™ìƒ ê´€ë¦¬</h1>
              <div className="flex items-center space-x-4 mb-2">
                <p className="text-gray-600">í•™ìƒë“¤ì˜ ê¸°ë³¸ ì •ë³´ì™€ êµìš°ê´€ê³„ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
                {user && (
                  <div className="flex items-center space-x-2 bg-blue-50 px-3 py-1 rounded-full">
                    <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span className="text-sm font-medium text-blue-700">
                      {user.name} ({user.role === 'homeroom_teacher' ? 'ë‹´ì„êµì‚¬' : 
                       user.role === 'grade_teacher' ? 'í•™ë…„ë¶€ì¥' :
                       user.role === 'school_admin' ? 'í•™êµê´€ë¦¬ì' : 'êµìœ¡ì²­ê´€ë¦¬ì'})
                    </span>
                    {user.role === 'homeroom_teacher' && user.grade && user.class && (
                      <span className="text-sm text-blue-600">
                        - {user.grade}í•™ë…„ {user.class}ë°˜ ë‹´ë‹¹
                      </span>
                    )}
                    {user.role === 'grade_teacher' && user.grade && (
                      <span className="text-sm text-blue-600">
                        - {user.grade}í•™ë…„ ë‹´ë‹¹
                      </span>
                    )}
                  </div>
                )}
              </div>
              {user?.role === 'homeroom_teacher' && (
                <div className="text-sm text-amber-600 bg-amber-50 px-3 py-1 rounded-lg inline-block">
                  ğŸ’¡ ë‹´ì„ì„ ìƒë‹˜ì€ ë‹´ë‹¹ ë°˜ í•™ìƒë“¤ë§Œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
              )}
            </div>
            <div className="flex space-x-3">
              <button
                onClick={handleDownloadTemplate}
                className="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
              >
                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
              </button>
              <button
                onClick={() => document.getElementById('excel-upload')?.click()}
                className="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                í•™ìƒ ëª…ë‹¨ ì—…ë¡œë“œ
              </button>
              <input
                id="excel-upload"
                type="file"
                accept=".csv,.xlsx,.xls"
                onChange={handleExcelUpload}
                className="hidden"
              />
            </div>
          </div>
        </div>

        {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
        {error && (
          <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-yellow-700">{error}</p>
              </div>
            </div>
          </div>
        )}

        {/* í•„í„° ì»¨íŠ¸ë¡¤ */}
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            {/* ê²€ìƒ‰ */}
            <div className="relative">
              <input
                type="text"
                placeholder="í•™ìƒ ì´ë¦„ ë˜ëŠ” í•™ë²ˆ ê²€ìƒ‰..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg className="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>

            {/* í•™ë…„ í•„í„° */}
            <select
              value={user?.role === 'homeroom_teacher' && user?.grade ? user.grade : gradeFilter}
              onChange={(e) => setGradeFilter(e.target.value)}
              disabled={user?.role === 'homeroom_teacher'}
              className={`px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                user?.role === 'homeroom_teacher' ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''
              }`}
            >
              {user?.role === 'homeroom_teacher' && user?.grade ? (
                <option value={user.grade}>{user.grade}í•™ë…„ (ë‹´ë‹¹)</option>
              ) : (
                <>
                  <option value="all">ëª¨ë“  í•™ë…„</option>
                  <option value="1">1í•™ë…„</option>
                  <option value="2">2í•™ë…„</option>
                  <option value="3">3í•™ë…„</option>
                </>
              )}
            </select>

            {/* ë°˜ í•„í„° */}
            <select
              value={user?.role === 'homeroom_teacher' && user?.class ? user.class : classFilter}
              onChange={(e) => setClassFilter(e.target.value)}
              disabled={user?.role === 'homeroom_teacher'}
              className={`px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                user?.role === 'homeroom_teacher' ? 'bg-gray-100 text-gray-500 cursor-not-allowed' : ''
              }`}
            >
              {user?.role === 'homeroom_teacher' && user?.class ? (
                <option value={user.class}>{user.class}ë°˜ (ë‹´ë‹¹)</option>
              ) : (
                <>
                  <option value="all">ëª¨ë“  ë°˜</option>
                  <option value="1">1ë°˜</option>
                  <option value="2">2ë°˜</option>
                  <option value="3">3ë°˜</option>
                </>
              )}
            </select>

            {/* ìœ„í—˜ë„ í•„í„° */}
            <select
              value={riskFilter}
              onChange={(e) => setRiskFilter(e.target.value)}
              className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="all">ëª¨ë“  ìœ„í—˜ë„</option>
              <option value="high">ì£¼ì˜ í•„ìš”</option>
              <option value="medium">ê´€ì°° ì¤‘</option>
              <option value="low">ì•ˆì •</option>
            </select>
          </div>
        </div>

        {/* í•™ìƒ ëª©ë¡ */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredStudents.length === 0 ? (
            <div className="col-span-full bg-white rounded-lg border border-gray-200 p-12 text-center">
              <svg className="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              <h3 className="text-lg font-medium text-gray-900 mb-2">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</h3>
              <p className="text-gray-500">ê²€ìƒ‰ ì¡°ê±´ì„ ë³€ê²½í•´ë³´ì„¸ìš”.</p>
            </div>
          ) : (
            filteredStudents.map(student => (
              <StudentCard
                key={student.id}
                student={student}
                onViewDetails={handleViewDetails}
                onAddMemo={handleAddMemo}
              />
            ))
          )}
        </div>
      </div>

      {/* í•™ìƒ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ */}
      <StudentDetailModal
        student={selectedStudent}
        isOpen={isDetailModalOpen}
        onClose={() => setIsDetailModalOpen(false)}
      />
    </div>
  );
};

export default RespondentManagement;